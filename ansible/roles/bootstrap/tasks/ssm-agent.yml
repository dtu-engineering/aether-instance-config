---
- block:

    - name: Ensure snapd is installed
      apt:
        name: snapd
        state: present
        update_cache: yes
      register: snapd_install
      retries: 5
      delay: 10
      until: snapd_install is succeeded

    - name: Install amazon-ssm-agent via snap
      community.general.snap:
        name: amazon-ssm-agent
        classic: yes
        state: present
      register: ssm_snap
      retries: 5
      delay: 10
      until: ssm_snap is succeeded

    - name: Enable SSM agent service
      ansible.builtin.systemd:
        name: snap.amazon-ssm-agent.amazon-ssm-agent.service
        enabled: yes

    - name: Start SSM agent service
      ansible.builtin.systemd:
        name: snap.amazon-ssm-agent.amazon-ssm-agent.service
        state: started

    - name: Set sysctl values
      ansible.builtin.command: "{{ item }}"
      loop:
        - sysctl -w fs.file-max=100000
        - sysctl -w fs.inotify.max_user_instances=256
        - sysctl -w fs.inotify.max_user_watches=16384

    - name: Restart SSM agent service after sysctl changes
      ansible.builtin.systemd:
        name: snap.amazon-ssm-agent.amazon-ssm-agent.service
        state: restarted

  rescue:
    - debug:
        msg: "Non-critical SSM Agent setup failed. Continuing..."
